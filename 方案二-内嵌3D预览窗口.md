# 方案二：Native 窗口内嵌 3D 预览

## 1. 目标与价值

### 解决什么问题
用户需要频繁在 DCPM 和外部 3D 查看器之间切换，工作流程被打断，且外部查看器启动慢、配置繁琐。

### 带来的价值
- **无缝体验**：在项目管理界面直接预览模型
- **即时交互**：零延迟的旋转、缩放、平移
- **统一环境**：无需切换窗口，保持工作上下文

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PyQt6 主窗口                                  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                      布局结构                                   │  │
│  │                                                               │  │
│  │  ┌──────────────┐  ┌───────────────────────────────────────┐  │  │
│  │  │              │  │           RightPanel                  │  │  │
│  │  │  FileBrowser │  │          右侧详情面板                  │  │  │
│  │  │              │  │                                       │  │  │
│  │  │  [文件列表]   │  │  ┌─────────────────────────────────┐  │  │  │
│  │  │              │  │  │     F3DPreviewWidget            │  │  │  │
│  │  │  📁 01_工程数据│  │  │     3D 预览组件                  │  │  │  │
│  │  │  📄 mold.step│  │  │                                 │  │  │  │
│  │  │              │  │  │  ┌─────────────────────────┐    │  │  │  │
│  │  │              │  │  │  │    Toolbar (工具栏)      │    │  │  │  │
│  │  │              │  │  │  │ [正视][侧视][等轴测][线框]│    │  │  │  │
│  │  │              │  │  │  └─────────────────────────┘    │  │  │  │
│  │  │              │◄─┼──┼─────────────────────────────────│  │  │  │
│  │  │              │  │  │  ┌─────────────────────────┐    │  │  │  │
│  │  │              │  │  │  │                         │    │  │  │  │
│  │  │              │  │  │  │    F3D Native Window    │    │  │  │  │
│  │  │              │  │  │  │    (OpenGL 渲染区域)     │    │  │  │  │
│  │  │              │  │  │  │                         │    │  │  │  │
│  │  │              │  │  │  │   • 鼠标拖动 = 旋转      │    │  │  │  │
│  │  │              │  │  │  │   • 滚轮 = 缩放          │    │  │  │  │
│  │  │              │  │  │  │   • 右击拖动 = 平移      │    │  │  │  │
│  │  │              │  │  │  │                         │    │  │  │  │
│  │  │              │  │  │  └─────────────────────────┘    │  │  │  │
│  │  │              │  │  │                                 │  │  │  │
│  │  └──────────────┘  │  │  ┌─────────────────────────┐    │  │  │  │
│  │                    │  │  │    StatusBar (状态栏)    │    │  │  │  │
│  │                    │  │  │    FPS: 60  顶点: 12500  │    │  │  │  │
│  │                    │  │  └─────────────────────────┘    │  │  │  │
│  │                    │  └─────────────────────────────────┘  │  │  │
│  │                    └───────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 窗口嵌入机制

```
┌─────────────────────────────────────────────────────────────────┐
│                     窗口层级关系 (Windows)                        │
│                                                                 │
│  Desktop Window (顶层桌面)                                       │
│         │                                                       │
│         └── PyQt6 MainWindow (DCPM 主窗口)                       │
│                 │                                               │
│                 └── Container Widget (QWidget)                   │
│                         │                                       │
│                         └── F3D Native Window (通过 SetParent)  │
│                                 • OpenGL Context                │
│                                 • 事件循环由 F3D 处理            │
│                                                                 │
│  关键技术: Win32 API SetParent() 将 F3D 窗口设为 Qt 的子窗口     │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 数据流与交互

```
┌─────────────────────────────────────────────────────────────────┐
│                        交互数据流                                 │
│                                                                 │
│   用户输入          F3DPreviewWidget           F3D Engine       │
│  ┌───────┐              ┌───────┐              ┌───────┐       │
│  │ 鼠标  │─────────────►│ 事件  │─────────────►│ 相机  │       │
│  │ 键盘  │   转发       │ 转换  │   API 调用    │ 控制  │       │
│  └───────┘              └───────┘              └───────┘       │
│                              │                       │          │
│                              │                       ▼          │
│                              │              ┌───────────────┐   │
│                              │              │   OpenGL      │   │
│                              │              │   渲染        │   │
│                              │              └───────┬───────┘   │
│                              │                      │           │
│                              ▼                      ▼           │
│                       ┌───────────────┐      ┌───────────────┐  │
│                       │   UI 更新     │      │  屏幕显示      │  │
│                       │  (状态/FPS)   │      │  (子窗口区域)  │  │
│                       └───────────────┘      └───────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 技术选型

### 3.1 为什么选择 Native 嵌入而非 Offscreen？

| 维度 | Native 嵌入 | Offscreen + QLabel |
|------|-------------|-------------------|
| 渲染性能 | ✅ GPU 直接渲染，零拷贝 | ❌ 每帧内存拷贝，CPU 负担 |
| 交互延迟 | ✅ < 16ms，丝滑流畅 | ❌ 30-60ms，略有迟滞 |
| 实现复杂度 | ❌ 需要窗口句柄操作 | ✅ 纯 Python，简单 |
| 跨平台 | ❌ 平台相关代码 | ✅ 跨平台 |
| 事件处理 | ✅ 原生支持 | ❌ 需手动转发 |

**结论**：追求极致体验，选择 Native 嵌入。

### 3.2 平台支持策略

```
Phase 1: Windows (优先)
        └── Win32 API SetParent
        └── HWND 窗口句柄操作
        └── 占 90% 用户

Phase 2: Linux (后续)
        └── X11 XReparentWindow
        └── 或 Wayland 协议

Phase 3: macOS (可选)
        └── NSView 层级操作
        └── 技术难度较高
```

---

## 4. 关键模块职责

### 4.1 F3DPreviewWidget

| 职责 | 说明 |
|------|------|
| 生命周期管理 | 初始化 F3D 引擎、加载模型、资源释放 |
| 窗口嵌入 | 获取 Native 窗口句柄，设为 Qt 子窗口 |
| 几何同步 | 监听 Qt 容器大小变化，同步调整 F3D 窗口 |
| 事件转发 | 将 Qt 鼠标/键盘事件转换为 F3D 交互 |
| 工具栏控制 | 视角切换、渲染模式、截图功能 |

### 4.2 F3D 引擎配置

```
初始化选项:
├── 渲染效果
│   ├── 环境光遮蔽 (Ambient Occlusion)
│   ├── 抗锯齿 (Anti-aliasing)
│   ├── 色调映射 (Tone Mapping)
│   └── 网格显示 (Grid)
├── 相机设置
│   ├── 透视/正交投影切换
│   └── 默认等轴测视角
└── 交互模式
    ├── 旋转 (左键拖动)
    ├── 平移 (右键拖动)
    └── 缩放 (滚轮)
```

---

## 5. 工作流程

### 5.1 初始化流程

```
1. 用户选中 3D 文件
        │
        ▼
2. RightPanel 创建/显示 F3DPreviewWidget
        │
        ▼
3. F3DPreviewWidget.initialize()
   ├─ 加载 F3D 插件 (OCCT/ASSIMP)
   ├─ 创建 Engine (Native 模式)
   ├─ 获取 Native Window Handle
   ├─ 调用 SetParent 嵌入 Qt 容器
   └─ 设置渲染选项
        │
        ▼
4. F3DPreviewWidget.load_model(file_path)
   ├─ 清除上一模型
   ├─ 加载新模型文件
   ├─ 自动调整相机视角
   └─ 开始渲染循环
        │
        ▼
5. 显示交互式 3D 预览
```

### 5.2 用户交互流程

```
鼠标左键拖动 ──────┐
鼠标右键拖动 ──────┼──► F3DPreviewWidget 事件过滤器
滚轮滚动 ──────────┤    └── 转发到 F3D Interactor
键盘快捷键 ────────┘         └── 相机变换
                                  │
                                  ▼
                           OpenGL 实时渲染
                                  │
                                  ▼
                           子窗口区域更新显示
```

### 5.3 清理流程

```
用户切换项目/关闭窗口
        │
        ▼
F3DPreviewWidget.closeEvent()
   ├─ 停止渲染定时器
   ├─ 清除场景 (scene.clear)
   ├─ 释放 Engine
   └─ 恢复窗口父子关系 (可选)
        │
        ▼
资源完全释放
```

---

## 6. 关键设计决策

### 6.1 渲染循环策略

| 方案 | 机制 | 选择 |
|------|------|------|
| A. 持续渲染 | 定时器 60FPS 持续调用 render() | ✅ 选择，确保流畅 |
| B. 按需渲染 | 仅交互时渲染，静止时停止 | 省电但首次显示慢 |

### 6.2 事件处理策略

| 方案 | 实现 | 选择 |
|------|------|------|
| A. 事件转发 | Qt 事件 → F3D Interactor | ✅ 选择，保持 F3D 原生体验 |
| B. 手动相机控制 | 自行计算相机参数 | 灵活但工作量大 |

### 6.3 多实例支持

- **限制**：同时只支持一个预览窗口（F3D Engine 单例限制）
- **切换策略**：选中新文件时销毁旧 Engine，创建新 Engine

---

## 7. 优缺点分析

### 优点
- ✅ 真正的原生 OpenGL 性能，无延迟
- ✅ F3D 完整功能支持（所有渲染选项、动画）
- ✅ 用户体验接近专业 CAD 软件

### 缺点
- ⚠️ 需要修改 F3D Python 绑定（暴露窗口句柄）
- ⚠️ 平台相关代码增加维护成本
- ⚠️ 窗口嵌入可能有边缘情况（焦点、Z序）
- ⚠️ 不支持同时预览多个模型

---

## 8. 风险与应对

| 风险 | 可能性 | 影响 | 应对方案 |
|------|--------|------|----------|
| 窗口嵌入失败 | 中 | 高 | 备选方案：Offscreen + QOpenGLWidget |
| 焦点问题（F3D 抢焦点） | 中 | 中 | 调整窗口样式，限制交互区域 |
| 多显示器 DPI 不一致 | 低 | 中 | 监听 DPI 变化，调整渲染比例 |
| F3D 崩溃 | 低 | 高 | 异常隔离，崩溃后优雅降级 |
| 显卡兼容性 | 低 | 高 | 检测 OpenGL 版本，不支持时提示 |

---

## 9. 依赖条件

### 9.1 F3D 绑定修改

需要 F3D Python 绑定暴露以下 API：

```
Engine.get_native_window_handle() -> int
    返回平台相关的窗口句柄
    Windows: HWND
    Linux: X11 Window ID
    macOS: NSView/Window pointer
```

### 9.2 构建要求

- F3D 需启用 OCCT 插件（支持 STEP/IGES）
- F3D 需启用 ASSIMP 插件（支持 OBJ/STL）
- Python 绑定需启用（BINDINGS_PYTHON）

---

## 10. 实施步骤（概要）

```
Phase 1: 可行性验证
        └── 验证 F3D 窗口句柄获取可行性
        └── 编写最小测试程序（Win32 嵌入）
        └── 评估性能与稳定性

Phase 2: F3D 绑定修改
        └── 修改 f3d/python/F3DPythonBindings.cxx
        └── 添加 get_native_window_handle() 方法
        └── 重新构建 F3D

Phase 3: Widget 开发
        └── F3DPreviewWidget 框架
        └── 窗口嵌入逻辑（Windows）
        └── 事件转发系统

Phase 4: 功能集成
        └── 工具栏（视角切换）
        └── 状态显示（FPS/顶点数）
        └── 截图功能

Phase 5: UI 集成
        └── RightPanel 添加预览区域
        └── FileBrowser 双击/选中触发
        └── 设置选项（启用/禁用预览）

Phase 6: 测试优化
        └── 多文件切换测试
        └── 长时间运行稳定性
        └── 边界情况（超大模型、损坏文件）
```

---

## 11. 预期效果

### 右侧详情面板

```
┌─────────────────────────────────────┐
│  项目详情                    [X]     │
├─────────────────────────────────────┤
│  文件名: mold.step                  │
│  大小: 15.3 MB                      │
│  修改: 2024-01-15 14:30             │
├─────────────────────────────────────┤
│  [正视] [侧视] [俯视图] [等轴测]    │
│  [线框] [网格✓] [边线]      [📷]   │
├─────────────────────────────────────┤
│                                     │
│         ╭─────────────────╮         │
│        ╱                   ╲        │
│       ╱    3D 模型预览      ╲       │
│      │    (真实交互区域)      │      │
│      │                       │      │
│      │  • 拖动旋转模型        │      │
│      │  • 滚轮缩放           │      │
│      │  • 右击平移           │      │
│       ╲                     ╱       │
│        ╲                   ╱        │
│         ╰─────────────────╯         │
│                                     │
│  FPS: 60 | 顶点: 12,450 | 面: 8,200 │
├─────────────────────────────────────┤
│  备注: 这是最终版模具设计            │
└─────────────────────────────────────┘
```

### 使用场景

1. **快速检查**：选中文件 → 右侧立即显示 3D 内容
2. **设计审查**：旋转查看细节，无需打开外部软件
3. **截图分享**：一键保存当前视角图片
4. **对比查看**：快速切换不同版本模型对比
