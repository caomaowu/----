# 方案一：后台任务缩略图生成系统

## 1. 目标与价值

### 解决什么问题
压铸项目中的 3D 文件（STEP/STL/IGES 等）在文件浏览器中只能显示默认图标，工程师无法快速识别文件内容，需要逐个打开查看。

### 带来的价值
- **快速识别**：通过缩略图一眼辨认模型内容
- **效率提升**：减少无效的文件打开操作
- **专业呈现**：符合现代 CAD/PLM 系统的使用体验

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         表现层 (UI)                              │
│  ┌──────────────┐         ┌──────────────────────────────────┐  │
│  │  FileBrowser │◄────────┤   ThumbnailItemDelegate         │  │
│  │   文件浏览器  │  请求   │   自定义图标绘制器                │  │
│  │              │         │   • 优先显示缩略图                │  │
│  │              │────────►│   • 无缩略图时显示默认图标+加载中 │  │
│  └──────────────┘  刷新   └──────────────────────────────────┘  │
│         ▲                                    │                  │
│         │                                    │ 查询             │
│         │ 更新通知                           ▼                  │
│         │                           ┌──────────────────┐        │
│         └───────────────────────────┤ ThumbnailService │        │
│                                     │   缩略图服务      │        │
│                                     │   • 内存缓存     │        │
│                                     │   • 磁盘缓存     │        │
│                                     │   • 任务调度     │        │
│                                     └────────┬─────────┘        │
└──────────────────────────────────────────────┼──────────────────┘
                                               │
                                               │ 未命中缓存时提交
                                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后台任务层                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────────┐   │
│  │   Scanner    │───►│  TaskQueue   │───►│ ThumbnailWorker  │   │
│  │   增量扫描器  │    │   任务队列    │    │   缩略图生成器    │   │
│  │   • 全量扫描  │    │   • 去重      │    │   • 调用 F3D     │   │
│  │   • 增量检测  │    │   • 优先级    │    │   • Offscreen    │   │
│  └──────────────┘    └──────────────┘    └────────┬─────────┘   │
│                                                   │             │
└───────────────────────────────────────────────────┼─────────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                       基础设施层                                 │
│  ┌────────────────────┐    ┌────────────────────────────────┐   │
│  │    CacheStorage    │    │         F3D Engine             │   │
│  │    磁盘缓存         │    │       (libf3d)                 │   │
│  │    ~/.pm_system/   │    │    • Offscreen 渲染            │   │
│  │       thumbnails/  │    │    • 多格式支持                │   │
│  └────────────────────┘    │    • 视角控制                  │   │
│                            └────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 缓存策略（双层缓存）

```
用户请求缩略图
      │
      ▼
┌─────────────────┐
│  1. 内存缓存     │◄─── 最近使用 (LRU)，100张上限
│  (QPixmap)      │      命中: 直接返回 (< 1ms)
│                 │      未命中: 继续
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  2. 磁盘缓存     │◄─── 持久化存储，基于文件哈希命名
│  (PNG 文件)     │      命中: 加载到内存并返回 (~50ms)
│                 │      未命中: 提交生成任务
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  3. 生成任务     │◄─── 提交到后台队列
│  (后台异步)      │      完成: 通知 UI 刷新
└─────────────────┘
```

### 2.3 任务调度流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  文件变更    │     │  定时触发    │     │  手动触发    │
│  (文件监听)  │     │  (每5分钟)   │     │  (用户点击)  │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           ▼
                  ┌─────────────────┐
                  │   增量扫描器     │
                  │   • 扫描 3D 文件 │
                  │   • 检查缓存状态 │
                  │   • 生成任务列表 │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │    任务队列      │
                  │   • 去重过滤     │
                  │   • 优先级排序   │
                  │   • 并发控制(≤2) │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │  F3D 渲染任务    │
                  │   • Offscreen    │
                  │   • 等轴测视角   │
                  │   • 128x128 PNG │
                  └────────┬────────┘
                           │
                           ▼
                  ┌─────────────────┐
                  │   缓存 & 通知    │
                  │   • 写入磁盘     │
                  │   • 更新内存     │
                  │   • 发送信号     │
                  └─────────────────┘
```

---

## 3. 技术选型

### 3.1 为什么选择后台任务而非实时渲染？

| 维度 | 后台任务 | 实时渲染 |
|------|----------|----------|
| 用户体验 | 浏览流畅，秒开 | 滚动时卡顿，等待感强 |
| 资源占用 | 可控（限并发数） | 不可控（高峰时卡死） |
| 实现复杂度 | 中（需任务调度） | 低（直接调用） |
| 缓存复用 | 完美支持 | 无 |

### 3.2 为什么选择 F3D Offscreen？

- **无窗口依赖**：不需要 X11/Win32 显示环境，适合后台运行
- **资源轻量**：不需要创建 OpenGL 上下文与窗口系统交互
- **性能足够**：单张 128x128 缩略图渲染 < 500ms

### 3.3 缓存键设计

使用 **文件路径 + 修改时间** 的哈希作为缓存键：
- 文件内容变化 → 修改时间变化 → 重新生成
- 文件重命名 → 路径变化 → 重新生成（符合预期）

---

## 4. 工作流程

### 4.1 正常浏览流程

```
1. 用户滚动文件浏览器
        │
        ▼
2. FileBrowser 请求每个可见项的图标
        │
        ▼
3. ThumbnailService 查询缓存
   ├─ 内存命中 → 立即返回缩略图
   ├─ 磁盘命中 → 加载到内存 → 返回
   └─ 均未命中 → 返回默认图标，提交后台任务
        │
        ▼
4. 后台任务完成 → 发送 thumbnail_ready 信号
        │
        ▼
5. FileBrowser 刷新对应项，显示缩略图
```

### 4.2 项目导入流程

```
1. 用户导入/新建项目
        │
        ▼
2. 项目创建完成
        │
        ▼
3. 后台扫描器检测到新文件
   (首次全量扫描或增量检测)
        │
        ▼
4. 新文件加入任务队列
        │
        ▼
5. 后台逐个生成缩略图
   (不阻塞用户操作)
        │
        ▼
6. 缩略图就绪后自动显示
```

---

## 5. 关键设计决策

### 5.1 缩略图尺寸

| 用途 | 尺寸 | 格式 |
|------|------|------|
| 文件浏览器图标 | 128x128 | PNG |
| 项目封面（可选扩展） | 400x300 | PNG |

### 5.2 并发控制

- **渲染线程数**：2（避免 CPU/GPU 满载影响主程序）
- **任务队列长度**：无限制（按需堆积）
- **优先级**：当前可见区域文件优先

### 5.3 失效策略

- **内存缓存**：LRU，上限 100 张
- **磁盘缓存**：无上限（需定期清理）
- **清理触发**：手动按钮或每月自动清理

---

## 6. 优缺点分析

### 优点
- ✅ 用户体验流畅，无卡顿感
- ✅ 缓存机制使常用文件秒开
- ✅ 不依赖显示环境，后台运行稳定
- ✅ 增量更新节省资源

### 缺点
- ⚠️ 新文件需要等待生成（数秒延迟）
- ⚠️ 占用额外磁盘空间（缓存文件）
- ⚠️ 首次全量扫描耗时（取决于项目数量）

---

## 7. 风险与应对

| 风险 | 可能性 | 应对方案 |
|------|--------|----------|
| F3D 渲染失败（文件损坏） | 中 | 任务异常捕获，标记为失败，不重复尝试 |
| 磁盘空间不足 | 低 | 设置缓存上限，LRU 清理 |
| 扫描时文件被占用 | 低 | 跳过正在写入的文件，下次扫描再处理 |
| 缩略图与文件不同步 | 低 | 基于修改时间的缓存键自动处理 |

---

## 8. 实施步骤（概要）

```
Step 1: 基础服务搭建
        └── ThumbnailService 类（缓存管理）
        └── ThumbnailWorker 类（F3D 渲染）
        └── 磁盘缓存目录初始化

Step 2: 后台任务系统
        └── BackgroundWorker 类（定时调度）
        └── ThumbnailScanner 类（增量扫描）
        └── 任务队列与并发控制

Step 3: UI 集成
        └── ThumbnailItemDelegate 类（自定义绘制）
        └── FileBrowser 集成（信号绑定）
        └── 设置面板（开关、清理缓存按钮）

Step 4: 优化与测试
        └── 性能测试（1000+ 文件场景）
        └── 内存泄漏检查
        └── 边界情况处理（损坏文件、超大模型）
```

---

## 9. 预期效果

### 文件浏览器图标模式

```
Before:
┌────────┬────────┬────────┬────────┐
│ [📄]   │ [📄]   │ [📄]   │ [📄]   │  ← 所有文件都是默认图标
│上模.step│下模.step│型芯.stl│图纸.pdf│
└────────┴────────┴────────┴────────┘

After:
┌────────┬────────┬────────┬────────┐
│[3D预览]│[3D预览]│[3D预览]│ [📄]   │  ← 3D文件显示内容预览
│上模.step│下模.step│型芯.stl│图纸.pdf│     非3D文件保持原样
└────────┴────────┴────────┴────────┘
```

### 状态指示

- **已缓存**：显示清晰缩略图
- **生成中**：显示默认图标 + 加载动画/标记
- **生成失败**：显示错误图标或保持默认图标
