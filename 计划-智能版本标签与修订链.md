# 智能版本标签与修订链（个人版）开发计划

目标：对 2D/3D/PDF/工艺等文件建立“同一资料的版本链”，并以“版本标签（第一版/第二版/…）”的交互方式完成标注、自动识别与“只看最新”的聚合视图，适配个人工作流。

## 1. 使用场景（以个人效率为核心）

- 我把某个 3D 文件标为「第一版」；后续把新文件放入项目目录时，系统能建议「第二版」并自动归到同一资料下。
- 在项目详情里，我能一键切换查看：
  - 只看最新版本（每份资料只显示最新文件）
  - 查看版本链（按版本排序的时间轴/列表）
- 版本号不必强制写进文件名；系统内部维护版本标签即可。

## 2. 概念与数据模型（最小必要集合）

### 2.1 核心概念

- 文件（File）：磁盘上的一个具体文件实例。
- 资料（Document/DocKey）：一份“同一资料”的抽象（例如某零件的 3D 模型、某工艺卡）。
- 版本（Version）：同一资料在不同时点的迭代（第一版、第二版…）。
- 版本标签（Version Tag）：展示层的标签样式，但语义上是单值、可排序的版本字段。

### 2.2 推荐字段（逻辑模型）

- File
  - file_id（稳定标识，可由路径哈希或内部自增）
  - path（绝对路径）
  - name（文件名）
  - ext（扩展名）
  - size_bytes
  - mtime（修改时间）
  - content_fingerprint（可选：hash / 文本指纹）
  - doc_id（可空：尚未归并到资料）
  - version_id（可空：尚未设置版本）

- Document
  - doc_id
  - title（展示名，默认来自文件基础名或用户命名）
  - kind（2D/3D/PDF/工艺/其他）
  - latest_version_id（冗余：加速“只看最新”）
  - created_at / updated_at

- Version
  - version_id
  - doc_id
  - version_index（整数：1,2,3…）
  - display_name（默认：第一版/第二版…；也可显示 V1/V2）
  - file_id（指向具体文件）
  - note（可选：改了什么）
  - created_at

## 3. “智能”的定义（离线、可解释、可学习）

### 3.1 自动归并（文件 → 资料）

目标：新文件进入项目后，系统能判断它属于哪个 Document（DocKey），并给出置信度。

分层策略（从强到弱，组合打分）：

- 确定性规则（高权重）
  - 同目录同类型：例如都在 `\3D\` 且扩展名在 3D 白名单
  - 文件名归一化后相同（去掉空格、括号内容、日期、常见后缀等）
- 模糊匹配（中权重）
  - 名称相似度（编辑距离/分词相似度）
  - 路径相似度（同项目、同子目录层级）
- 人工学习（长期收益）
  - 当用户确认“归并到某资料”后，记录归并映射（特征 → doc_id）

输出：Top-N 候选 doc_id + 置信度；当置信度高于阈值时可自动归并，否则给出建议卡片。

### 3.2 自动建议版本（资料内：版本号 +1）

触发条件：文件已归并到 doc_id 但尚无 version_index。

建议逻辑：

- 如果文件名中存在可解析版本号（如 V2/R02/REV-B/第二版），优先使用解析结果。
- 否则建议为 `max(version_index)+1`。
- 支持“覆盖同名文件”的检测：若发现同路径文件指纹变化，可提示“检测到更新，是否创建新版本”。

### 3.3 版本标签展示规则

- 默认显示：第一版/第二版/第三版…
- 可切换显示：V1/V2/V3（用于对外沟通或习惯）

## 4. UI 设计（保持美观：三栏结构中的自然落位）

### 4.1 主列表：文件视图与“只看最新”

- 视图开关：
  - 全部文件
  - 只看最新（每个 doc_id 仅展示 latest_version_id 对应文件）
- 列表项展示：
  - 文件名（或资料标题）
  - 类型图标（2D/3D/PDF/工艺）
  - 版本标签（第一版/第二版…，高识别度配色）
  - 最新标记（Latest）

### 4.2 右侧详情：资料面板 + 版本链

- 顶部：资料标题 + 类型 + 常用操作（打开最新、打开所在目录）
- 中部：版本链列表（按 version_index 排序）
  - 每行：版本标签 + 文件名 + 时间 + “打开/定位”
- 底部：版本操作
  - “设为第一版/第二版…”（下拉）
  - “+ 新版本”（自动 +1，并绑定到当前文件）
  - “移动到其他资料…”（归并纠错）

### 4.3 智能建议卡（非打扰、可一键处理）

当检测到新文件：

- 文案：可能属于【资料标题】，建议标为【下一版】（置信度 xx%）
- 操作：接受 / 选择其他资料 / 忽略

## 5. 文件类型策略（个人版优先级）

- 第一阶段：3D（.step/.stp/.igs/.iges）+ PDF + 常见工艺文件（.xlsx/.pdf）
- 第二阶段：2D（.dwg/.dxf）仅做“文件名/路径归并”，不做内容解析
- 内容解析（可选增强）：
  - PDF：可做标题栏文本提取/关键字识别（离线）
  - OCR：作为后续增强（需要额外依赖与性能评估）

## 6. 存储与索引（与现有 FTS5 并存）

- 版本链属于结构化数据：建议放 SQLite 普通表（与现有 FTS5 同库或同目录）
- 关键索引：
  - File.path 唯一/索引
  - Version.doc_id + version_index 索引
  - Document.latest_version_id 索引（加速“只看最新”）

## 7. 实施步骤（里程碑）

### M1：可用的版本链（无智能）

- 新增 Document/Version 数据结构与存储
- 文件详情页支持手动设置版本标签（第一版/第二版/…）
- 资料详情页展示版本链
- “只看最新”聚合视图

验收：同一资料能被人工串成链；最新版本展示稳定。

### M2：半自动（建议归并 + 建议下一版）

- 自动生成 DocKey 候选（基于目录/扩展名/名称归一化）
- 新文件进入时弹出建议卡（可接受/修正）
- 自动建议下一版（max+1）

验收：常见命名/目录习惯下，建议命中率高，且不会打扰。

### M3：学习与去重（更智能）

- 记录用户确认历史（特征 → doc_id）
- 文件指纹去重（避免重复版本/重复入库）
- 覆盖同名文件检测：提示创建新版本

验收：越用越准；重复文件不会污染版本链。

## 8. 风险与策略

- 归并误判：默认“不自动入链”，以“建议卡 + 一键纠错”为主；并提供“撤销/移动到其他资料”。
- 命名习惯不统一：用“名称归一化 + 学习映射”逐步适配个人习惯。
- 性能：扫描时增量更新；指纹与相似度计算做缓存；UI 列表按需加载。

## 9. 验收清单（功能完成标准）

- 能对任意文件设置版本标签（第一版/第二版…）
- 能将多个文件归并为同一资料并形成版本链
- 能稳定展示“只看最新”
- 新文件进入时能给出可解释的归并与版本建议，并支持一键确认/纠错
